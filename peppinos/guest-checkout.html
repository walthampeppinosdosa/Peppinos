<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary meta tags -->
  <title>Guest Checkout - Peppino's Restaurant</title>
  <meta name="title" content="Guest Checkout - Peppino's Restaurant">
  <meta name="description" content="Complete your order as a guest at Peppino's Restaurant">

  <!-- Favicon -->
  <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

  <!-- Google font link -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

  <!-- Custom CSS link -->
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="stylesheet" href="./assets/css/cart.css">
  <link rel="stylesheet" href="./assets/css/components.css">

  <!-- Preload images -->
  <link rel="preload" as="image" href="./assets/images/hero-slider-1.png">
  <link rel="preload" as="image" href="./assets/images/hero-slider-2.png">
  <link rel="preload" as="image" href="./assets/images/hero-slider-3.png">

  <style>
    .checkout-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow-1);
    }

    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid var(--cultured);
      border-radius: 8px;
    }

    .form-section h3 {
      color: var(--gold-crayola);
      margin-bottom: 1rem;
      font-family: var(--ff-forum);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--eerie-black-1);
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e5e5e5;
      border-radius: 8px;
      font-size: 16px;
      background-color: var(--white);
      color: var(--eerie-black-1);
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold-crayola);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--quick-silver);
      opacity: 0.8;
    }

    .radio-group {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .radio-option input[type="radio"] {
      width: auto;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .btn-checkout {
      width: 100%;
      padding: 1rem;
      background: var(--gold-crayola);
      color: var(--white);
      border: none;
      border-radius: 4px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .btn-checkout:hover {
      background: var(--golden-poppy);
    }

    .btn-checkout:disabled {
      background: var(--cultured);
      cursor: not-allowed;
      position: relative;
    }

    .btn-checkout.loading {
      color: transparent;
    }

    .btn-checkout.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .error-message {
      color: var(--red-orange-crayola);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .success-message {
      color: var(--green);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .restaurant-status {
      background: var(--red-orange-crayola);
      color: var(--white);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Cart Summary Styles */
    .cart-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--cultured);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-image {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .cart-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .cart-item-details {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 600;
      color: var(--eerie-black-1);
      margin-bottom: 0.25rem;
    }

    .cart-item-info {
      font-size: 0.875rem;
      color: var(--quick-silver);
    }

    .cart-item-price {
      font-weight: 600;
      color: var(--gold-crayola);
    }

    .cart-totals {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--cultured);
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .total-final {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--gold-crayola);
      border-top: 1px solid var(--cultured);
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }

    .empty-cart {
      text-align: center;
      padding: 2rem;
      color: var(--quick-silver);
    }

    .empty-cart ion-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .radio-group {
        flex-direction: column;
      }

      .checkout-container {
        margin: 1rem;
        padding: 1rem;
      }

      .cart-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .cart-item-details {
        width: 100%;
      }

      /* Mobile form improvements */
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 1rem;
      }
    }

    /* Desktop form improvements */
    @media (min-width: 769px) {
      .form-group input,
      .form-group select,
      .form-group textarea {
        font-size: 16px; /* Larger font size for better readability */
        padding: 1rem;
      }

      .radio-option {
        padding: 0.75rem;
        border: 1px solid var(--cultured);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: var(--transition-1);
      }

      .radio-option:hover,
      .radio-option:has(input:checked) {
        border-color: var(--gold-crayola);
        background: var(--white-alpha-10);
      }

      .btn-checkout {
        padding: 1.25rem;
        font-size: 1.2rem;
        border-radius: 8px;
      }

      /* Better touch targets */
      .radio-option input[type="radio"] {
        width: 20px;
        height: 20px;
      }

      .radio-option label {
        font-size: 1.1rem;
        cursor: pointer;
      }
    }
  </style>
</head>

<body id="top">

  <!-- HEADER -->
  <header class="header" data-header>
    <div class="container">
      <a href="index.html" class="logo">
        <div class="logo-container">
          <div class="logo-face logo-face-1">
            <img src="./assets/images/logo-1.png" width="360" height="114" alt="Peppino's Dosa - Home">
          </div>
          <div class="logo-face logo-face-2">
            <img src="./assets/images/logo-2.png" width="360" height="114" alt="Peppino's Dosa - Home">
          </div>
          <div class="logo-face logo-face-3">
            <img src="./assets/images/logo-3.png" width="360" height="114" alt="Peppino's Dosa - Home">
          </div>
        </div>
      </a>

      <nav class="navbar" data-navbar>
        <button class="close-btn" aria-label="close menu" data-nav-toggler>
          <ion-icon name="close-outline" aria-hidden="true"></ion-icon>
        </button>

        <ul class="navbar-list">
          <li class="navbar-item">
            <a href="index.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">Home</span>
            </a>
          </li>

          <li class="navbar-item">
            <a href="menu.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">Menus</span>
            </a>
          </li>

          <li class="navbar-item">
            <a href="about.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">About Us</span>
            </a>
          </li>

          <li class="navbar-item">
            <a href="chefs.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">Our Chefs</span>
            </a>
          </li>

          <li class="navbar-item">
            <a href="catering.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">Catering</span>
            </a>
          </li>

          <li class="navbar-item">
            <a href="contact.html" class="navbar-link hover-underline">
              <div class="separator"></div>
              <span class="span">Contact</span>
            </a>
          </li>
        </ul>

        <div class="text-center">
          <p class="headline-1 navbar-title">Visit Us</p>
          <address class="body-4">
            434 Moody St, <br>
            Waltham, MA 02453
          </address>

          <p class="body-4 navbar-text">Lunch Buffet: Mon-Fri 11:30AM-3PM</p>
          <a href="mailto:walthampeppinosdosa@gmail.com" class="body-4 sidebar-link">walthampeppinosdosa@gmail.com</a>

          <div class="separator"></div>

          <p class="contact-label">Booking Request</p>
          <a href="tel:+17815476099" class="body-1 contact-number hover-underline">
            (781) 547-6099
          </a>
        </div>

        <div class="navbar-actions">
          <!-- Auth buttons will be populated by JavaScript -->
          <div id="auth-buttons"></div>
        </div>
      </nav>

      <div class="header-actions">
        <a href="https://www.google.com/maps/place/Peppino's+Dosa" target="_blank" class="btn btn-google" rel="noopener">
          <span class="text text-1">Google Business</span>
          <span class="text text-2" aria-hidden="true">Google Business</span>
        </a>

  

        <!-- Auth buttons will be populated by JavaScript -->
        <div id="auth-buttons"></div>

        <!-- Cart Icon -->
        <button class="cart-icon-btn" id="cartIcon" aria-label="Open cart">
          <ion-icon name="bag-outline"></ion-icon>
          <span class="cart-count" id="cartCount">0</span>
        </button>
      </div>

      <button class="nav-open-btn" aria-label="open menu" data-nav-toggler>
        <span class="line line-1"></span>
        <span class="line line-2"></span>
        <span class="line line-3"></span>
      </button>

      <div class="overlay" data-nav-toggler data-overlay></div>
    </div>
  </header>

  <main>
    <article>
      <!-- CHECKOUT SECTION -->
      <section class="section checkout" aria-label="checkout">
        <div class="container">
          <div class="checkout-container">
            <h2 class="headline-1 section-title text-center">Guest Checkout</h2>
            
            <div class="restaurant-status" id="restaurantStatus" style="display: none;">
              <p>Closed â‹… Opens 11:30AM</p>
              <p>The restaurant is now closed, but you may schedule an order for later.</p>
            </div>

            <!-- Cart Summary -->
            <div class="form-section" id="cartSummary">
              <h3>Order Summary</h3>
              <div id="cartItems">
                <!-- Cart items will be populated here -->
              </div>
              <div class="cart-totals">
                <div class="total-row">
                  <span>Subtotal:</span>
                  <span id="cartSubtotal">$0.00</span>
                </div>
                <div class="total-row">
                  <span>Tax (7%):</span>
                  <span id="cartTax">$0.00</span>
                </div>
                <div class="total-row total-final">
                  <span>Total:</span>
                  <span id="cartTotal">$0.00</span>
                </div>
              </div>
            </div>

            <form id="guestCheckoutForm">
              <!-- Customer Information -->
              <div class="form-section">
                <h3>Tell Us About Yourself</h3>
                <p class="body-4" style="margin-bottom: 1rem;">All information below is required.</p>
                
                <div class="form-group">
                  <label for="customerName">Name *</label>
                  <input type="text" id="customerName" name="customerName" required>
                  <div class="error-message" id="customerNameError"></div>
                </div>

                <div class="form-group">
                  <label for="customerPhone">Phone Number *</label>
                  <input type="tel" id="customerPhone" name="customerPhone" required>
                  <div class="error-message" id="customerPhoneError"></div>
                </div>

                <div class="form-group">
                  <label for="customerEmail">Email *</label>
                  <input type="email" id="customerEmail" name="customerEmail" required>
                  <div class="error-message" id="customerEmailError"></div>
                </div>
              </div>

              <!-- Order Type -->
              <div class="form-section">
                <h3>Order Type</h3>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="pickup" name="orderType" value="pickup">
                    <label for="pickup">Pickup</label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="delivery" name="orderType" value="delivery" checked>
                    <label for="delivery">Delivery</label>
                  </div>
                </div>
              </div>

              <!-- Delivery Address (shown only for delivery) -->
              <div class="form-section" id="deliveryAddressSection">
                <h3>Delivery Address</h3>
                
                <div class="form-group">
                  <label for="street">Street Address *</label>
                  <input type="text" id="street" name="street" required>
                  <div class="error-message" id="streetError"></div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="city">City *</label>
                    <input type="text" id="city" name="city" required>
                    <div class="error-message" id="cityError"></div>
                  </div>

                  <div class="form-group">
                    <label for="state">State *</label>
                    <input type="text" id="state" name="state" required>
                    <div class="error-message" id="stateError"></div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="zipCode">ZIP Code *</label>
                    <input type="text" id="zipCode" name="zipCode" required>
                    <div class="error-message" id="zipCodeError"></div>
                  </div>

                  <div class="form-group">
                    <label for="country">Country</label>
                    <input type="text" id="country" name="country" value="United States">
                  </div>
                </div>
              </div>

              <!-- Timing -->
              <div class="form-section">
                <h3>Timing</h3>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="asap" name="timing" value="asap" checked>
                    <label for="asap">ASAP</label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="scheduled" name="timing" value="scheduled">
                    <label for="scheduled">Schedule</label>
                  </div>
                </div>

                <!-- Scheduled Time Section -->
                <div id="scheduledTimeSection" style="display: none; margin-top: 1rem;">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="scheduledDate">Pick Day *</label>
                      <input type="date" id="scheduledDate" name="scheduledDate">
                      <div class="error-message" id="scheduledDateError"></div>
                    </div>

                    <div class="form-group">
                      <label for="scheduledTime">Pick Time *</label>
                      <input type="time" id="scheduledTime" name="scheduledTime">
                      <div class="error-message" id="scheduledTimeError"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Payment Information -->
              <div class="form-section">
                <h3>Payment Information</h3>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="payOnline" name="paymentMethod" value="pay_online" checked>
                    <label for="payOnline">Pay Online</label>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="payInStore" name="paymentMethod" value="pay_in_store">
                    <label for="payInStore">Pay in Store</label>
                  </div>
                </div>
              </div>

              <!-- Special Instructions -->
              <div class="form-section">
                <h3>Special Instructions</h3>
                <div class="form-group">
                  <textarea id="specialInstructions" name="specialInstructions" rows="4" 
                    placeholder="Special instructions, allergies, etc..."></textarea>
                  <div class="error-message" id="specialInstructionsError"></div>
                </div>
              </div>

              <button type="submit" class="btn-checkout" id="submitBtn">
                Place Order
              </button>
            </form>
          </div>
        </div>
      </section>
    </article>
  </main>

  <!-- FOOTER -->
  <footer class="footer section has-bg-image text-center"
    style="background-image: url('./assets/images/footer-bg.jpg')">
    <div class="container">
      <div class="footer-top grid-list">
        <div class="footer-brand">
          <a href="./index.html" class="logo">
            <img src="./assets/images/logo-1.png" width="160" height="50" alt="Peppino's - Home">
          </a>

          <address class="body-4">
            Restaurant St, Delicious City, <br>
            London 9578, UK
          </address>

          <a href="mailto:booking@peppinos.com" class="body-4 contact-link">booking@peppinos.com</a>
          <a href="tel:+88123123456" class="body-4 contact-link">Booking Request : +88-123-123456</a>

          <p class="body-4">
            Open : 09:00 am - 01:00 pm
          </p>

          <div class="wrapper">
            <div class="separator"></div>
            <div class="separator"></div>
            <div class="separator"></div>
          </div>

          <!-- <p class="title-1">Get News & Offers</p>
          <p class="label-1">
            Subscribe us & Get <span class="span">25% Off.</span>
          </p> -->

          <form action="" class="input-wrapper">
            <div class="icon-wrapper">
              <ion-icon name="mail-outline" aria-hidden="true"></ion-icon>
              <input type="email" name="email_address" placeholder="Your email" autocomplete="off" class="input-field">
            </div>
            <button type="submit" class="btn btn-secondary">
              <span class="text text-1">Subscribe</span>
              <span class="text text-2" aria-hidden="true">Subscribe</span>
            </button>
          </form>
        </div>

        <ul class="footer-list">
          <li>
            <a href="./index.html" class="label-2 footer-link hover-underline">Home</a>
          </li>
          <li>
            <a href="./menu.html" class="label-2 footer-link hover-underline">Menus</a>
          </li>
          <li>
            <a href="./about.html" class="label-2 footer-link hover-underline">About Us</a>
          </li>
          <li>
            <a href="./contact.html" class="label-2 footer-link hover-underline">Contact</a>
          </li>
        </ul>

        <ul class="footer-list">
          <li>
            <a href="#" class="label-2 footer-link hover-underline">Facebook</a>
          </li>
          <li>
            <a href="#" class="label-2 footer-link hover-underline">Instagram</a>
          </li>
          <li>
            <a href="#" class="label-2 footer-link hover-underline">Twitter</a>
          </li>
          <li>
            <a href="#" class="label-2 footer-link hover-underline">Youtube</a>
          </li>
          <li>
            <a href="#" class="label-2 footer-link hover-underline">Google Map</a>
          </li>
        </ul>
      </div>

      <div class="footer-bottom">
        <p class="copyright">
          &copy; 2024 Peppino's. All Rights Reserved | Crafted by <a href="#" target="_blank"
            class="link">codewithsadee</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- Back to top button -->
  <a href="#top" class="back-top-btn active" aria-label="back to top" data-back-top-btn>
    <ion-icon name="chevron-up" aria-hidden="true"></ion-icon>
  </a>

  <!-- Custom JS link -->
  <script src="./assets/js/script.js"></script>

  <!-- Checkout functionality -->
  <script type="module">
    import { CONFIG } from './assets/js/config.js';
    import { cartService } from './assets/js/services/cart-service.js';
    import { cartUI } from './assets/js/components/cart-ui.js';
    import { formatCurrency, showError, showSuccess } from './assets/js/ui.js';
    import { restaurantHours } from './assets/js/services/restaurant-hours.js';

    class CheckoutManager {
      constructor() {
        this.form = document.getElementById('guestCheckoutForm');
        this.cartSummary = document.getElementById('cartSummary');
        this.cartItems = document.getElementById('cartItems');
        this.submitBtn = document.getElementById('submitBtn');
        this.init();
      }

      async init() {
        // Wait for cart system to be ready (initialized by navigation.js) with timeout
        let waitTime = 0;
        const maxWaitTime = 10000; // 10 seconds max wait
        while (!window.cartSystemInitialized && waitTime < maxWaitTime) {
          await new Promise(resolve => setTimeout(resolve, 100));
          waitTime += 100;
        }

        if (!window.cartSystemInitialized) {
          console.warn('Cart system not initialized after 10 seconds, proceeding anyway');
        }
        this.setupEventListeners();
        this.updateCartSummary();
        this.setupFormValidation();
        this.updateRestaurantStatus();
        this.setupMobileEnhancements();

        // Listen for cart updates (with debouncing to prevent infinite loops)
        let cartUpdateTimeout;
        cartService.addEventListener((cart) => {
          clearTimeout(cartUpdateTimeout);
          cartUpdateTimeout = setTimeout(() => {
            this.updateCartSummary();
          }, 100);
        });
      }

      setupEventListeners() {
        // Order type change
        document.querySelectorAll('input[name="orderType"]').forEach(radio => {
          radio.addEventListener('change', this.handleOrderTypeChange.bind(this));
        });

        // Timing change
        document.querySelectorAll('input[name="timing"]').forEach(radio => {
          radio.addEventListener('change', this.handleTimingChange.bind(this));
        });

        // Form submission
        this.form.addEventListener('submit', this.handleFormSubmit.bind(this));
      }

      handleOrderTypeChange(e) {
        const deliverySection = document.getElementById('deliveryAddressSection');
        if (e.target.value === 'delivery') {
          deliverySection.style.display = 'block';
          this.setDeliveryFieldsRequired(true);
        } else {
          deliverySection.style.display = 'none';
          this.setDeliveryFieldsRequired(false);
        }
      }

      handleTimingChange(e) {
        const scheduledSection = document.getElementById('scheduledTimeSection');
        if (e.target.value === 'scheduled') {
          scheduledSection.style.display = 'block';
          document.getElementById('scheduledDate').required = true;
          document.getElementById('scheduledTime').required = true;
        } else {
          scheduledSection.style.display = 'none';
          document.getElementById('scheduledDate').required = false;
          document.getElementById('scheduledTime').required = false;
        }
      }

      setDeliveryFieldsRequired(required) {
        const fields = ['street', 'city', 'state', 'zipCode'];
        fields.forEach(fieldId => {
          document.getElementById(fieldId).required = required;
        });
      }

      updateCartSummary() {
        const cart = cartService.cart;

        if (!cart || !cart.items || cart.items.length === 0) {
          this.cartItems.innerHTML = `
            <div class="empty-cart">
              <ion-icon name="bag-outline"></ion-icon>
              <p>Your cart is empty</p>
              <a href="./menu.html" class="btn btn-primary" style="margin-top: 1rem;">Browse Menu</a>
            </div>
          `;
          this.submitBtn.disabled = true;
          return;
        }

        // Render cart items
        this.cartItems.innerHTML = cart.items.map(item => this.renderCartItem(item)).join('');

        // Update totals
        const subtotal = cart.subtotal || 0;
        const tax = cartService.calculateTax(subtotal);
        const total = subtotal + tax;

        document.getElementById('cartSubtotal').textContent = formatCurrency(subtotal);
        document.getElementById('cartTax').textContent = formatCurrency(tax);
        document.getElementById('cartTotal').textContent = formatCurrency(total);

        this.submitBtn.disabled = false;
      }

      renderCartItem(item) {
        const menu = item.menu || {};
        const imageUrl = menu.images && menu.images.length > 0
          ? menu.images[0].url
          : './assets/images/menu-1.png';

        return `
          <div class="cart-item">
            <div class="cart-item-image">
              <img src="${imageUrl}" alt="${menu.name || 'Menu Item'}" loading="lazy">
            </div>
            <div class="cart-item-details">
              <div class="cart-item-name">${menu.name || 'Menu Item'}</div>
              <div class="cart-item-info">
                Qty: ${item.quantity} | Size: ${item.size || 'Medium'}
                ${item.addons && item.addons.length > 0 ? `<br>Add-ons: ${item.addons.map(addon => addon.name).join(', ')}` : ''}
                ${item.specialInstructions ? `<br>Note: ${item.specialInstructions}` : ''}
              </div>
            </div>
            <div class="cart-item-price">
              ${formatCurrency(item.itemTotal || 0)}
            </div>
          </div>
        `;
      }

      updateRestaurantStatus() {
        const status = restaurantHours.getStatusMessage();
        const statusElement = document.getElementById('restaurantStatus');

        if (!status.isOpen) {
          statusElement.style.display = 'block';
          statusElement.innerHTML = `
            <p>${status.message}</p>
            <p>The restaurant is now closed, but you may schedule an order for later.</p>
          `;

          // Force scheduling if closed
          document.getElementById('scheduled').checked = true;
          this.handleTimingChange({ target: { value: 'scheduled' } });
          document.getElementById('asap').disabled = true;
        } else {
          statusElement.style.display = 'none';
          document.getElementById('asap').disabled = false;
        }
      }

      setupFormValidation() {
        // Set minimum date for scheduling (today if open, tomorrow if closed)
        const today = new Date();
        const isOpen = restaurantHours.isCurrentlyOpen();
        const minDate = isOpen ? today : new Date(today.getTime() + 24 * 60 * 60 * 1000);

        document.getElementById('scheduledDate').min = minDate.toISOString().split('T')[0];

        // Set maximum date (30 days from now)
        const maxDate = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
        document.getElementById('scheduledDate').max = maxDate.toISOString().split('T')[0];

        // Initialize form state
        this.handleOrderTypeChange({ target: { value: 'delivery' } });
        this.handleTimingChange({ target: { value: 'asap' } });

        // Setup date change listener for time slots
        document.getElementById('scheduledDate').addEventListener('change', this.updateTimeSlots.bind(this));
        document.querySelectorAll('input[name="orderType"]').forEach(radio => {
          radio.addEventListener('change', this.updateTimeSlots.bind(this));
        });
      }

      updateTimeSlots() {
        const dateInput = document.getElementById('scheduledDate');
        const timeInput = document.getElementById('scheduledTime');
        const orderType = document.querySelector('input[name="orderType"]:checked')?.value || 'pickup';

        if (!dateInput.value) {
          timeInput.innerHTML = '<option value="">Select a date first</option>';
          return;
        }

        const selectedDate = new Date(dateInput.value + 'T00:00:00');
        const timeSlots = restaurantHours.getAvailableTimeSlots(selectedDate, orderType);

        if (timeSlots.length === 0) {
          timeInput.innerHTML = '<option value="">No available times</option>';
          return;
        }

        // Convert time input to select dropdown
        if (timeInput.tagName !== 'SELECT') {
          const select = document.createElement('select');
          select.id = 'scheduledTime';
          select.name = 'scheduledTime';
          select.required = timeInput.required;
          timeInput.parentNode.replaceChild(select, timeInput);
        }

        const selectElement = document.getElementById('scheduledTime');
        selectElement.innerHTML = '<option value="">Select a time</option>' +
          timeSlots.map(slot => `<option value="${slot.time}">${slot.display}</option>`).join('');
      }

      async handleFormSubmit(e) {
        e.preventDefault();
        console.log('ðŸš€ Guest form submission started');

        if (!cartService.cart || !cartService.cart.items || cartService.cart.items.length === 0) {
          showError('Your cart is empty. Please add items before placing an order.');
          return;
        }

        // Validate scheduled time if scheduling
        const timing = new FormData(this.form).get('timing');
        if (timing === 'scheduled') {
          const scheduledDate = new FormData(this.form).get('scheduledDate');
          const scheduledTime = new FormData(this.form).get('scheduledTime');
          const orderType = new FormData(this.form).get('orderType');

          if (!scheduledDate || !scheduledTime) {
            showError('Please select a date and time for your scheduled order.');
            return;
          }

          const selectedDate = new Date(scheduledDate + 'T00:00:00');
          if (!restaurantHours.isTimeSlotAvailable(selectedDate, scheduledTime, orderType)) {
            showError('The selected time slot is no longer available. Please choose another time.');
            this.updateTimeSlots();
            return;
          }
        }

        try {
          this.submitBtn.disabled = true;
          this.submitBtn.classList.add('loading');
          this.submitBtn.textContent = 'Processing...';

          const formData = new FormData(this.form);
          const orderData = this.buildOrderData(formData);

          // Submit order using the guest checkout API endpoint
          const response = await fetch(`${CONFIG.API.BASE_URL}/api/shop/guest/checkout`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          console.log('ðŸ“¦ Guest order creation result:', result);
          console.log('ðŸ“¦ Response status:', response.status);
          console.log('ðŸ“¦ Response ok:', response.ok);

          if (!result.success) {
            // Show detailed error message in toast
            let errorMessage = result.message || 'Failed to place order';

            // If there's a specific validation error, show it
            if (result.error) {
              if (result.error.includes('duplicate key error') && result.error.includes('email')) {
                errorMessage = 'This email is already registered. Please use a different email or sign in to your account.';
              } else if (result.error.includes('validation failed')) {
                // Extract validation error details
                const validationMatch = result.error.match(/validation failed: (.+)/);
                if (validationMatch) {
                  errorMessage = `Validation Error: ${validationMatch[1]}`;
                }
              } else if (result.error.includes('Phone number is required')) {
                errorMessage = 'Phone number is required for delivery address.';
              }
            }

            showError(errorMessage);
            this.submitBtn.disabled = false;
            this.submitBtn.classList.remove('loading');
            this.submitBtn.textContent = 'Place Order';
            return;
          }

          console.log('ðŸ“¦ Guest order creation result:', result);
          console.log('âœ… Guest order created successfully, clearing cart...');

          // Clear cart (don't let this fail the order)
          try {
            await cartService.clearCart();
            console.log('âœ… Guest cart cleared successfully');
          } catch (cartError) {
            console.warn('âš ï¸ Guest cart clearing failed, but order was successful:', cartError);
            // Cart clearing failure shouldn't affect the successful order
          }

          // Show success message
          console.log('ðŸŽ‰ Showing guest success toast...');
          const order = result.data?.order || result.order;
          console.log('ðŸŽ‰ Guest order object:', order);
          const successMessage = `Order placed successfully! Order #${order.orderNumber}. Confirmation emails have been sent.`;
          console.log('ðŸŽ‰ Guest success message:', successMessage);
          showSuccess(successMessage);

          // Redirect to confirmation page after a short delay
          setTimeout(() => {
            console.log('ðŸ”„ Redirecting to order confirmation page...');
            window.location.href = `./order-confirmation.html?orderId=${order._id}`;
          }, 2000);

        } catch (error) {
          console.error('Error placing order:', error);

          // Show user-friendly error message
          let errorMessage = 'Failed to place order. Please try again.';

          // Handle network errors
          if (error.message.includes('fetch')) {
            errorMessage = 'Network error. Please check your connection and try again.';
          } else if (error.message) {
            errorMessage = error.message;
          }

          showError(errorMessage);
          this.submitBtn.disabled = false;
          this.submitBtn.classList.remove('loading');
          this.submitBtn.textContent = 'Place Order';
        }
      }

      buildOrderData(formData) {
        const cart = cartService.cart;
        const orderData = {
          // Customer information (guest checkout format)
          customer: {
            name: formData.get('customerName'),
            phoneNumber: formData.get('customerPhone'),
            email: formData.get('customerEmail')
          },

          // Order details
          orderType: formData.get('orderType'),
          timing: formData.get('timing'),
          paymentMethod: formData.get('paymentMethod'),
          specialInstructions: formData.get('specialInstructions'),

          // Session info for guest orders
          sessionId: cartService.sessionId
        };

        // Add delivery address if delivery order
        if (formData.get('orderType') === 'delivery') {
          orderData.deliveryAddress = {
            street: formData.get('street'),
            city: formData.get('city'),
            state: formData.get('state'),
            zipCode: formData.get('zipCode'),
            country: formData.get('country') || 'United States',
            phoneNumber: formData.get('customerPhone') // Required by Order model
          };
        }

        // Add scheduled time if scheduled
        if (formData.get('timing') === 'scheduled') {
          orderData.scheduledDate = formData.get('scheduledDate');
          orderData.scheduledTime = formData.get('scheduledTime');
        }

        return orderData;
      }

      /**
       * Setup mobile-specific enhancements
       */
      setupMobileEnhancements() {
        // Improve form scrolling on mobile
        if (window.innerWidth <= 768) {
          // Smooth scroll to form sections when they become active
          const formSections = document.querySelectorAll('.form-section');
          formSections.forEach(section => {
            const inputs = section.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
              input.addEventListener('focus', () => {
                setTimeout(() => {
                  section.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                  });
                }, 300); // Wait for keyboard to appear
              });
            });
          });

          // Handle viewport changes for mobile keyboard
          let initialHeight = window.innerHeight;
          window.addEventListener('resize', () => {
            const currentHeight = window.innerHeight;
            const heightDiff = initialHeight - currentHeight;

            if (heightDiff > 150) {
              // Keyboard is likely open
              document.body.style.paddingBottom = '0px';
            } else {
              // Keyboard is closed
              document.body.style.paddingBottom = '';
            }
          });

          // Add touch feedback for radio buttons
          document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('touchstart', () => {
              option.style.transform = 'scale(0.98)';
            });

            option.addEventListener('touchend', () => {
              setTimeout(() => {
                option.style.transform = '';
              }, 100);
            });

            // Make entire radio option clickable
            option.addEventListener('click', () => {
              const radio = option.querySelector('input[type="radio"]');
              if (radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
              }
            });
          });

          // Prevent double-tap zoom on form elements
          document.addEventListener('touchend', (e) => {
            if (e.target.closest('.form-section')) {
              e.preventDefault();
            }
          });
        }
      }
    }

    // Initialize checkout manager when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new CheckoutManager();
    });
  </script>

  <!-- Ionicon link -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

  <!--
    - authentication integration
  -->
  <script type="module" src="./assets/js/config.js"></script>
  <script type="module" src="./assets/js/navigation.js"></script>
  <script type="module" src="./assets/js/auth.js"></script>

</body>

</html>
